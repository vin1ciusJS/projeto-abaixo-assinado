<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Abaixo-assinado</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="admin-page-body">

    <div id="password-gate" class="password-gate-container">
        <div class="password-box">
            <i class="fa-solid fa-lock"></i>
            <h2>Acesso Restrito</h2>
            <p>Insira a senha do painel para gerar o relatório de assinaturas.</p>
            <input type="password" id="admin-password" placeholder="••••••••••">
            <button id="login-button" class="admin-cta-button">Acessar Painel</button>
            <p id="error-message" class="error-text"></p>
        </div>
    </div>

    <div id="content-area" class="admin-dashboard" style="display: none;">
        <aside class="sidebar">
            <a href="index.html" class="navbar-brand">
                <div class="final-logo">
                    <div class="logo-icon-wrapper">
                        <i class="fa-solid fa-trash-can-arrow-up icon-open"></i>
                        <i class="fa-solid fa-trash-can icon-closed"></i>
                    </div>
                    <div class="logo-text-group">
                        <span class="logo-title">Professor</span>
                        <span class="logo-name">Marcilon</span>
                    </div>
                </div>
            </a>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active"><i class="fa-solid fa-file-lines"></i> Relatório</a>
                <a href="index.html" class="nav-item"><i class="fa-solid fa-arrow-left"></i> Voltar ao Site</a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="main-header">
                <h1>Relatório de Assinaturas</h1>
                <div class="controls">
                    <button id="load-button" class="admin-cta-button"><i class="fa-solid fa-sync"></i> Carregar Assinaturas</button>
                    <button id="print-button" class="admin-cta-button secondary" style="display: none;"><i class="fa-solid fa-print"></i> Gerar PDF</button>
                </div>
            </div>
            <p id="status" class="status-text"></p>
            
            <div class="table-container">
                <table id="signatures-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome Completo</th>
                            <th>Data / Hora</th>
                            <th class="ip-column">IP do Assinante</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="pdf-content" style="display: none;">
        <div class="pdf-header">
            <div class="pdf-logo">
                <span class="brand-line-1">Professor</span>
                <span class="brand-line-2">Marcilon</span>
            </div>
            <div class="pdf-title">
                <h1>ABAIXO-ASSINADO PELA REVOGAÇÃO DA TAXA DE LIXO</h1>
                <h2>Valparaíso de Goiás</h2>
            </div>
        </div>
        <div class="pdf-petition-text">
            <p>Nós, os cidadãos abaixo-assinados, residentes e eleitores no município de Valparaíso de Goiás, em pleno gozo de nossos direitos civis, vimos por meio deste solicitar formalmente à Câmara Municipal de Vereadores e à Prefeitura a imediata revogação da Lei Municipal que instituiu a Taxa de Coleta, Manuseio e Destinação de Resíduos Sólidos Urbanos (Taxa de Lixo). A referida cobrança representa um ônus fiscal injusto e desproporcional para a população, sem a devida contrapartida na melhoria do serviço. Reivindicamos, portanto, que a gestão de resíduos seja financiada por fontes do orçamento geral do município, em respeito à capacidade contributiva dos cidadãos.</p>
        </div>
        <div id="pdf-table-container"></div>
        <div class="pdf-footer">
            <p>Documento gerado em <span id="generation-date"></span>, contendo um total de <span id="total-signatures"></span> assinaturas válidas.</p>
            <span class="page-number"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const passwordGate = document.getElementById('password-gate');
            const contentArea = document.getElementById('content-area');
            const passwordInput = document.getElementById('admin-password');
            const loginButton = document.getElementById('login-button');
            const errorMessage = document.getElementById('error-message');
            const SECRET_KEY = 'ValparaisoForte2025';

            loginButton.addEventListener('click', () => {
                if (passwordInput.value === SECRET_KEY) {
                    passwordGate.style.display = 'none';
                    contentArea.style.display = 'flex';
                } else {
                    errorMessage.textContent = 'Senha incorreta.';
                    passwordInput.focus();
                }
            });

            const loadButton = document.getElementById('load-button');
            const printButton = document.getElementById('print-button');
            const statusEl = document.getElementById('status');
            const tableBody = document.querySelector('#signatures-table tbody');
            const pdfTableContainer = document.getElementById('pdf-table-container');
            
            let signaturesData = [];

            loadButton.addEventListener('click', async () => {
                statusEl.textContent = 'Buscando dados no servidor...';
                loadButton.disabled = true;

                try {
                    const response = await fetch('/api/getSignatures', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ secret: SECRET_KEY })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Não foi possível buscar os dados.');
                    }

                    signaturesData = await response.json();
                    
                    tableBody.innerHTML = '';
                    // --- CORREÇÃO APLICADA AQUI ---
                    // Preenche a tabela do painel com as colunas corretas (incluindo IP)
                    signaturesData.forEach((sig, index) => {
                        const signatureDate = sig.data_assinatura ? new Date(sig.data_assinatura).toLocaleString('pt-BR') : 'N/A';
                        tableBody.innerHTML += `<tr><td>${index + 1}</td><td>${sig.nome}</td><td>${signatureDate}</td><td class="ip-column">${sig.endereco_ip || 'N/A'}</td></tr>`;
                    });
                    
                    statusEl.textContent = `${signaturesData.length} assinaturas carregadas.`;
                    printButton.style.display = 'inline-flex';

                } catch (error) {
                    statusEl.textContent = `Erro: ${error.message}`;
                    loadButton.disabled = false;
                }
            });

            printButton.addEventListener('click', () => {
                document.getElementById('generation-date').textContent = new Date().toLocaleDateString('pt-BR', { dateStyle: 'long' });
                document.getElementById('total-signatures').textContent = signaturesData.length;
                
                // Cria a tabela para o PDF com as colunas corretas (SEM o IP)
                const tableToPrint = document.createElement('table');
                tableToPrint.innerHTML = `
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome Completo</th>
                            <th>Data / Hora da Assinatura</th>
                            <th>Endereço</th>
                            <th>Telefone</th>
                            <th>E-mail</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${signaturesData.map((sig, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${sig.nome}</td>
                                <td>${sig.data_assinatura ? new Date(sig.data_assinatura).toLocaleString('pt-BR') : 'N/A'}</td>
                                <td>${sig.endereco || ''}</td>
                                <td>${sig.telefone || ''}</td>
                                <td>${sig.email || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                
                pdfTableContainer.innerHTML = '';
                pdfTableContainer.appendChild(tableToPrint);

                window.print();
            });
        });
    </script>
</body>
</html>